<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Center</title>
  <link rel="icon" href="icon.png" type="image/png">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 { text-align: center; margin-bottom: 20px; }

    .search-container { text-align: center; margin-bottom: 30px; }
    .search-container input {
      width: 80%; max-width: 400px; padding: 10px;
      border-radius: 8px; border: 1px solid #ccc;
    }

    .wrap {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .software {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
    }

    .software img { width: 64px; height: 64px; object-fit: contain; }

    .download-btn {
      background: #0070f3; color: white; padding: 10px 18px;
      display: inline-block; border-radius: 6px;
      text-decoration: none;
    }

    footer { margin-top: 40px; text-align: center; color: #777; }

    /* Drag & Drop */
    .drop-zone {
      border: 2px dashed #0070f3;
      background: #eef6ff;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
    }
    .drop-zone.dragover { background: #d9ecff; }

    /* Modal */
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%; max-width: 400px;
      border-radius: 10px;
    }
    .close { float: right; cursor: pointer; font-size: 20px; }

    #dashboard {
      display: none; background: #fff; padding: 20px;
      border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .btn { padding: 8px 14px; border-radius: 6px; cursor: pointer; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-primary { background: #0070f3; color: #fff; }

    .software-admin-item {
      border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin-bottom: 10px;
    }
  </style>
</head>

<body>

<h1>Download Center</h1>

<!-- ADMIN LOGIN BUTTON -->
<div style="text-align:center;">
  <button class="btn-success" onclick="openLoginModal()">Admin Login</button>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeLoginModal()">&times;</span>
    <h3>Admin Login</h3>
    <form onsubmit="login(event)">
      <input type="email" id="email" placeholder="Email" required><br><br>
      <input type="password" id="password" placeholder="Password" required><br><br>
      <button class="btn-primary" type="submit">Login</button>
    </form>
    <p id="loginError" style="color:red;display:none;">Invalid email or password</p>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h3>Edit Software</h3>

    <form id="editForm" onsubmit="updateSoftware(event)">
      <input type="hidden" id="editId">

      <label>Title:</label>
      <input id="editTitle" required><br><br>

      <label>Image URL:</label>
      <input id="editImageUrl" required><br><br>

      <label>Checksum:</label>
      <input id="editChecksum" required><br><br>

      <!-- DRAG & DROP FOR EDIT -->
      <label>Upload New File (optional):</label>
      <div id="editDropZone" class="drop-zone">Drag & drop file or click</div>
      <input type="file" id="editFileInput" hidden>
      <p id="editUploadStatus"></p>

      <button class="btn-success" type="submit" style="margin-top:10px;">Update</button>
    </form>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <h2>Admin Dashboard</h2>
  <button class="btn-danger" onclick="logout()">Logout</button>

  <h3 style="margin-top:20px;">Add New Software</h3>
  <form id="addForm" onsubmit="addSoftware(event)">
    <label>Title:</label>
    <input id="title" required><br><br>

    <label>Image URL:</label>
    <input id="imageUrl" required><br><br>

    <label>Checksum:</label>
    <input id="checksum" required><br><br>

    <!-- ADD NEW DRAG & DROP -->
    <label>Upload File:</label>
    <div id="dropZone" class="drop-zone">Drag & drop file or click</div>
    <input type="file" id="fileInput" hidden>
    <p id="uploadStatus"></p>

    <button class="btn-success" type="submit" style="margin-top:10px;">Add</button>
  </form>

  <h3 style="margin-top:20px;">Existing Software</h3>
  <div id="adminSoftwareList"></div>
</div>

<!-- SEARCH BAR -->
<div class="search-container">
  <input id="searchBox" placeholder="Search software...">
</div>

<!-- PUBLIC LIST -->
<div id="softwareList" class="wrap"></div>

<footer>Â© 2025 Download Center</footer>

<!-- FIREBASE SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc }
  from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3Rd_IT34AN7LQKKrkuyonE3nEmXGGt5E",
  authDomain: "download-center-4f997.firebaseapp.com",
  projectId: "download-center-4f997",
  storageBucket: "download-center-4f997.firebasestorage.app",
  messagingSenderId: "120966837626",
  appId: "1:120966837626:web:d3489bc4e3e245651f52c3",
  measurementId: "G-4S4BRL4FW2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);
const storage = getStorage(app);

let uploadedFileURL = null;
let editUploadedFileURL = null;

/* ---------------------- LOGIN ---------------------- */
window.login = async (event) => {
  event.preventDefault();
  try {
    await signInWithEmailAndPassword(auth,
      email.value, password.value
    );
    closeLoginModal();
    loginError.style.display = "none";
  } catch {
    loginError.style.display = "block";
  }
};

window.logout = () => signOut(auth);

/* ------------------- AUTH STATE ------------------- */
onAuthStateChanged(auth, (user) => {
  dashboard.style.display = user ? "block" : "none";
  loadSoftware();
  if (user) loadAdminList();
});

/* ------------------- LOAD PUBLIC LIST ------------------- */
async function loadSoftware() {
  const snap = await getDocs(collection(db, "software"));
  softwareList.innerHTML = "";
  snap.forEach(docx => {
    const d = docx.data();
    softwareList.innerHTML += `
      <div class="software">
        <img src="${d.imageUrl}">
        <h2>${d.title}</h2>
        <a class="download-btn" href="${d.downloadUrl}">Download</a>
        <p class="checksum">${d.checksum}</p>
      </div>`;
  });
  attachSearch();
}

/* ------------------- LOAD ADMIN LIST ------------------- */
async function loadAdminList() {
  const snap = await getDocs(collection(db, "software"));
  adminSoftwareList.innerHTML = "";
  snap.forEach(docx => {
    const d = docx.data();
    adminSoftwareList.innerHTML += `
      <div class="software-admin-item">
        <strong>${d.title}</strong><br>
        <img src="${d.imageUrl}" width="32"><br>
        <button class="btn-primary" onclick="openEditModal('${docx.id}', ${JSON.stringify(d).replace(/"/g,'&quot;')})">Edit</button>
        <button class="btn-danger" onclick="deleteSoftware('${docx.id}')">Delete</button>
      </div>`;
  });
}

/* ------------------ DELETE ------------------ */
window.deleteSoftware = async (id) => {
  if (!confirm("Delete this item?")) return;
  await deleteDoc(doc(db, "software", id));
  loadSoftware(); loadAdminList();
};

/* ------------------- ADD NEW SOFTWARE ------------------- */
window.addSoftware = async (event) => {
  event.preventDefault();
  if (!uploadedFileURL) return alert("Upload a file first!");

  await addDoc(collection(db, "software"), {
    title: title.value,
    imageUrl: imageUrl.value,
    checksum: checksum.value,
    downloadUrl: uploadedFileURL
  });

  uploadedFileURL = null;
  uploadStatus.textContent = "";
  addForm.reset();
  loadSoftware(); loadAdminList();
};

/* ------------------- EDIT SOFTWARE ------------------- */
window.openEditModal = (id, data) => {
  editId.value = id;
  editTitle.value = data.title;
  editImageUrl.value = data.imageUrl;
  editChecksum.value = data.checksum;
  editUploadedFileURL = null;
  editUploadStatus.textContent = "";
  editModal.style.display = "block";
};

window.updateSoftware = async (event) => {
  event.preventDefault();

  const id = editId.value;
  const newURL = editUploadedFileURL;

  await updateDoc(doc(db, "software", id), {
    title: editTitle.value,
    imageUrl: editImageUrl.value,
    checksum: editChecksum.value,
    downloadUrl: newURL || undefined
  });

  closeEditModal();
  loadSoftware(); loadAdminList();
};

/* ---------------------- MODALS ----------------------- */
window.openLoginModal = () => loginModal.style.display = "block";
window.closeLoginModal = () => loginModal.style.display = "none";
window.closeEditModal = () => editModal.style.display = "none";

/* ------------------- SEARCH ------------------- */
function attachSearch() {
  searchBox.addEventListener('input', () => {
    const term = searchBox.value.toLowerCase();
    document.querySelectorAll('.software').forEach(x => {
      x.style.display = x.querySelector("h2").textContent.toLowerCase().includes(term)
        ? "block" : "none";
    });
  });
}

/* ---------------- DRAG & DROP UPLOAD ---------------- */
function setupDrop(dropZoneEl, fileInputEl, statusEl, isEditMode = false) {
  const setFile = (file) => {
    const path = "software/" + Date.now() + "_" + file.name;
    const storageRef = ref(storage, path);
    const uploadTask = uploadBytesResumable(storageRef, file);

    uploadTask.on("state_changed",
      snap => statusEl.textContent =
        "Uploading " + Math.floor(100 * snap.bytesTransferred / snap.totalBytes) + "%",
      err => statusEl.textContent = "Error: " + err.message,
      async () => {
        const url = await getDownloadURL(uploadTask.snapshot.ref);
        statusEl.textContent = "Upload complete";

        if (isEditMode) editUploadedFileURL = url;
        else uploadedFileURL = url;
      }
    );
  };

  dropZoneEl.onclick = () => fileInputEl.click();

  dropZoneEl.addEventListener("dragover", e => {
    e.preventDefault();
    dropZoneEl.classList.add("dragover");
  });

  dropZoneEl.addEventListener("dragleave", () =>
    dropZoneEl.classList.remove("dragover")
  );

  dropZoneEl.addEventListener("drop", e => {
    e.preventDefault();
    dropZoneEl.classList.remove("dragover");
    setFile(e.dataTransfer.files[0]);
  });

  fileInputEl.addEventListener("change", () =>
    setFile(fileInputEl.files[0])
  );
}

/* INIT DRAG DROP */
setupDrop(dropZone, fileInput, uploadStatus, false);
setupDrop(editDropZone, editFileInput, editUploadStatus, true);

</script>
</body>
</html>
