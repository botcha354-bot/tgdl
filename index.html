<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Software Downloads</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #f8f9fa;
  color: #333;
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}

h1 { text-align:center; color:#222; margin-bottom:20px; }

.search-container { text-align:center; margin-bottom:30px; }
.search-container input {
  width: 80%;
  max-width: 400px;
  padding: 10px 15px;
  font-size: 16px;
  border:1px solid #ccc;
  border-radius:8px;
  outline:none;
  transition:border-color 0.2s;
}
.search-container input:focus { border-color:#0070f3; }

.wrap {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
  gap:20px;
  padding:10px;
}

.software {
  background:#fff;
  padding:20px;
  border:1px solid #ddd;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
  text-align:center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.software:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }

.software img { width:64px; height:64px; object-fit:contain; margin-bottom:10px; }
.software h2 { margin:0 0 10px 0; font-size:1.1em; color:#0070f3; }

.download-btn {
  display:inline-block;
  margin-top:10px;
  padding:10px 18px;
  background:#0070f3;
  color:white;
  text-decoration:none;
  border-radius:6px;
  transition: background 0.2s ease;
}
.download-btn:hover { background:#0056c7; }

.checksum { font-size:0.9em; color:#555; margin-top:8px; word-break:break-all; }

footer { text-align:center; color:#777; margin-top:40px; font-size:0.9em; }

.hidden { display:none; }

/* Admin buttons and modals */
.admin-section { text-align:center; margin-bottom:20px; }
.admin-btn, .login-btn, .btn { 
  padding:10px 20px; background:#0070f3; color:white; border:none; border-radius:6px; cursor:pointer;
  font-size:16px;
}
.admin-btn:hover, .login-btn:hover, .btn:hover { background:#0056c7; }

.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color:#fff; margin:15% auto; padding:20px; border-radius:10px; width:80%; max-width:400px; text-align:center; position:relative; }
.close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
.close:hover { color:#000; }

input[type="password"], input[type="email"], input[type="text"], input[type="url"] {
  width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:4px;
}

#dashboard { display:none; margin-top:30px; padding:20px; background:#fff; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);}
#dashboard h2 { text-align:center; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; }

.software-list-admin { margin-top:20px; }
.software-admin-item { border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px; text-align:center; }
.software-admin-item img { margin-bottom:5px; }

#editModal .modal-content { width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
#editForm input { margin-bottom:10px; }

/* Drag and Drop */
.upload-area {
  border: 2px dashed #0070f3;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  margin-bottom:10px;
  cursor: pointer;
  color: #555;
}
.upload-area.dragover { background: #f0f8ff; }
.delete-upload { background:#dc3545; margin-top:5px; display:inline-block; padding:5px 10px; border-radius:4px; color:white; cursor:pointer; }
</style>
</head>
<body>

<h1>Download Center</h1>

<div class="admin-section">
  <button class="admin-btn" onclick="openLoginModal()">Admin Login</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeLoginModal()">&times;</span>
    <h3>Admin Login</h3>
    <form onsubmit="login(event)">
      <input type="email" id="email" placeholder="Email (e.g., admin@example.com)" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit" class="login-btn">Login</button>
    </form>
    <p id="loginError" style="color:red; display:none;">Invalid credentials!</p>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h3>Edit Software</h3>
    <form id="editForm" onsubmit="updateSoftware(event)">
      <input type="hidden" id="editId">
      <div class="form-group">
        <label>Title:</label>
        <input type="text" id="editTitle" required>
      </div>
      <div class="form-group">
        <label>Upload File:</label>
        <div class="upload-area" id="editUploadArea">Drag & drop or click to upload</div>
        <input type="file" id="editFileInput" style="display:none;">
        <div id="editUploadedFile"></div>
      </div>
      <button type="submit" class="btn">Update</button>
    </form>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <h2>Admin Dashboard</h2>
  <button class="btn" onclick="logout()">Logout</button>

  <h3>Add New Software</h3>
  <form id="addForm" onsubmit="addSoftware(event)">
    <div class="form-group">
      <label>Title:</label>
      <input type="text" id="title" required>
    </div>
    <div class="form-group">
      <label>Upload File:</label>
      <div class="upload-area" id="uploadArea">Drag & drop or click to upload</div>
      <input type="file" id="fileInput" style="display:none;">
      <div id="uploadedFile"></div>
    </div>
    <button type="submit" class="btn">Add</button>
  </form>

  <div class="software-list-admin">
    <h3>Manage Software</h3>
    <div id="adminSoftwareList"></div>
  </div>
</div>

<!-- Public View -->
<div class="search-container">
  <input type="text" id="searchBox" placeholder="Search software...">
</div>
<div class="wrap" id="softwareList"></div>

<footer>Â© 2025 My Software Downloads</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD3Rd_IT34AN7LQKKrkuyonE3nEmXGGt5E",
  authDomain: "download-center-4f997.firebaseapp.com",
  projectId: "download-center-4f997",
  storageBucket: "download-center-4f997.appspot.com",
  messagingSenderId: "120966837626",
  appId: "1:120966837626:web:d3489bc4e3e245651f52c3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// State for uploads
let addFile = null;
let editFile = null;

// Auto-icon map (minimal black/white)
const fileIcons = {
  'zip': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Fzip.png?alt=media',
  'exe': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Fexe.png?alt=media',
  'apk': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Fapk.png?alt=media',
  'rar': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Frar.png?alt=media',
  'msi': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Fmsi.png?alt=media',
  'pdf': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Fpdf.png?alt=media',
  'default': 'https://firebasestorage.googleapis.com/v0/b/download-center-4f997.appspot.com/o/icons%2Ffile.png?alt=media'
};

function getFileIcon(filename){
  const ext = filename.split('.').pop().toLowerCase();
  return fileIcons[ext] || fileIcons['default'];
}

// Auth State Listener
onAuthStateChanged(auth, (user)=>{
  document.getElementById('dashboard').style.display = user? 'block':'none';
  loadSoftware();
  if(user) loadAdminList();
});

// Login
window.login = async (e)=>{
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  try{ await signInWithEmailAndPassword(auth,email,password); closeLoginModal(); document.getElementById('loginError').style.display='none';}
  catch{ document.getElementById('loginError').style.display='block'; }
};

window.logout = ()=> signOut(auth);
window.openLoginModal = ()=> document.getElementById('loginModal').style.display='block';
window.closeLoginModal = ()=> document.getElementById('loginModal').style.display='none';
window.openEditModal = (id,data)=>{
  document.getElementById('editId').value=id;
  document.getElementById('editTitle').value=data.title;
  editFile=null;
  document.getElementById('editUploadedFile').innerHTML='';
  document.getElementById('editModal').style.display='block';
};
window.closeEditModal = ()=> document.getElementById('editModal').style.display='none';

// Upload Helpers
function setupUpload(areaId,inputId,uploadedDiv,callback){
  const area=document.getElementById(areaId);
  const input=document.getElementById(inputId);
  const uploaded=document.getElementById(uploadedDiv);
  area.addEventListener('click',()=>input.click());
  area.addEventListener('dragover',(e)=>{e.preventDefault();area.classList.add('dragover');});
  area.addEventListener('dragleave',(e)=>{area.classList.remove('dragover');});
  area.addEventListener('drop',(e)=>{
    e.preventDefault(); area.classList.remove('dragover');
    if(e.dataTransfer.files.length>0) input.files=e.dataTransfer.files;
    input.dispatchEvent(new Event('change'));
  });
  input.addEventListener('change',()=>{
    if(input.files.length>0){
      callback(input.files[0],uploaded);
    }
  });
}

// Display uploaded file with delete button
function showUploadedFile(file,div,callback){
  div.innerHTML=`${file.name} <span class="delete-upload" onclick="(${callback.toString()})(null)">Delete</span>`;
}

// Add File Upload
setupUpload('uploadArea','fileInput','uploadedFile',(file,div)=>{
  addFile=file;
  showUploadedFile(file,div,(f)=>{addFile=null;div.innerHTML='';});
});

// Edit File Upload
setupUpload('editUploadArea','editFileInput','editUploadedFile',(file,div)=>{
  editFile=file;
  showUploadedFile(file,div,(f)=>{editFile=null;div.innerHTML='';});
});

// Upload to Firebase Storage
async function uploadFile(file){
  const storageRef = ref(storage,'software/'+Date.now()+'_'+file.name);
  const uploadTask = uploadBytesResumable(storageRef,file);
  return new Promise((resolve,reject)=>{
    uploadTask.on('state_changed',null,(err)=>reject(err),()=>{
      getDownloadURL(uploadTask.snapshot.ref).then(resolve);
    });
  });
}

// Load software for public
async function loadSoftware(){
  const listDiv=document.getElementById('softwareList');
  listDiv.innerHTML='';
  const snapshot=await getDocs(collection(db,'software'));
  snapshot.forEach(doc=>{
    const data=doc.data();
    const card=document.createElement('div'); card.className='software';
    const img=document.createElement('img'); img.src=data.imageUrl; img.alt=data.title;
    const h2=document.createElement('h2'); h2.textContent=data.title;
    const a=document.createElement('a'); a.href=data.downloadUrl; a.className='download-btn'; a.textContent='Download'; a.target='_blank';
    const p=document.createElement('p'); p.className='checksum'; p.textContent=data.checksum;
    card.append(img,h2,a,p);
    listDiv.appendChild(card);
  });
  attachSearch();
}

// Admin List
async function loadAdminList(){
  const listDiv=document.getElementById('adminSoftwareList'); listDiv.innerHTML='';
  const snapshot=await getDocs(collection(db,'software'));
  snapshot.forEach(doc=>{
    const data=doc.data(); const id=doc.id;
    const div=document.createElement('div'); div.className='software-admin-item';
    const img=document.createElement('img'); img.src=data.imageUrl; img.width=32; img.height=32;
    const strong=document.createElement('strong'); strong.textContent=data.title;
    const btnEdit=document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Edit'; btnEdit.onclick=()=>openEditModal(id,data);
    const btnDel=document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Delete'; btnDel.onclick=()=>deleteSoftware(id,data.downloadUrl);
    div.append(strong,img,btnEdit,btnDel);
    listDiv.appendChild(div);
  });
}

// Add Software
window.addSoftware=async(e)=>{
  e.preventDefault();
  if(!addFile){ alert('Please upload a file'); return; }
  try{
    const downloadUrl=await uploadFile(addFile);
    const iconUrl=getFileIcon(addFile.name);
    await addDoc(collection(db,'software'),{
      title:document.getElementById('title').value,
      downloadUrl:downloadUrl,
      checksum:addFile.name,
      imageUrl:iconUrl
    });
    addFile=null; document.getElementById('addForm').reset(); document.getElementById('uploadedFile').innerHTML='';
    loadSoftware(); loadAdminList();
  }catch(err){ alert('Error: '+err.message);}
};

// Update Software
window.updateSoftware=async(e)=>{
  e.preventDefault();
  const id=document.getElementById('editId').value;
  const data={ title:document.getElementById('editTitle').value };
  try{
    if(editFile){
      // delete old file
      const docSnap=await getDocs(collection(db,'software'));
      const oldFileUrl=(await doc(db,'software',id).get()).data()?.downloadUrl;
      if(oldFileUrl){
        const oldRef=ref(storage,oldFileUrl.split('?')[0].split('/o/')[1]);
        await deleteObject(oldRef).catch(()=>{});
      }
      const downloadUrl=await uploadFile(editFile);
      data.downloadUrl=downloadUrl;
      data.checksum=editFile.name;
      data.imageUrl=getFileIcon(editFile.name);
      editFile=null; document.getElementById('editUploadedFile').innerHTML='';
    }
    await updateDoc(doc(db,'software',id),data);
    closeEditModal(); loadSoftware(); loadAdminList();
  }catch(err){ alert('Error: '+err.message);}
};

// Delete Software
async function deleteSoftware(id,url){
  if(confirm('Delete this software?')){
    try{
      if(url){ 
        const storagePath=url.split('?')[0].split('/o/')[1]; 
        const fileRef=ref(storage,decodeURIComponent(storagePath));
        await deleteObject(fileRef).catch(()=>{});
      }
      await deleteDoc(doc(db,'software',id));
      loadSoftware(); loadAdminList();
    }catch(err){ alert('Error: '+err.message);}
  }
}

// Search
function attachSearch(){
  const box=document.getElementById('searchBox');
  box.addEventListener('input',()=>{
    const query=box.value.toLowerCase();
    document.querySelectorAll('#softwareList .software').forEach(card=>{
      const title=card.querySelector('h2').textContent.toLowerCase();
      card.style.display=title.includes(query)?'block':'none';
    });
  });
}

</script>

</body>
</html>
